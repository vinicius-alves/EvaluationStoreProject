
with importances as (
  select feature, importance, row_number() over (order by importance desc) as rank_feature
  from (
    SELECT t0.* , max(t0.idrun) over() as last_run  
    from mysql.mydb.featureimportance  as t0 
    left join mysql.mydb.run as t1
    on t0.idrun = t1.idrun 
  )
  where idrun = last_run
)
 
, features as (
  SELECT DISTINCT timestamp,  date_trunc('month', timestamp) as mes , 
  cast(value as double) value, name, type,  namespace from mongodb.mydb.feature 
  where   type  in ('int','float')
  and value is not null  
)

select t0.*, t1.rank_feature from features as t0
left join importances as t1 
on t0.name = t1.feature